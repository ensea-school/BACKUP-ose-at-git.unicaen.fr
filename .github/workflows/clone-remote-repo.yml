name: Clone from GitLab

on:
  workflow_dispatch:
  schedule:
    - cron: "0 0 * * *"  # Déclenche tous les jours à minuit UTC

jobs:
  clone-repo:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout this GitHub repository
        uses: actions/checkout@v3

      - name: Check for updates in GitLab repository
        run: |
          # Récupérer le dernier commit de la branche principale du dépôt GitLab public
          latest_commit_gitlab=$(git ls-remote https://git.unicaen.fr/open-source/OSE.git HEAD | awk '{print $1}')
          echo "Dernier commit sur GitLab : $latest_commit_gitlab"
          
          # Récupérer le dernier commit actuellement dans le dépôt GitHub
          latest_commit_github=$(git ls-remote origin HEAD | awk '{print $1}')

          # Comparer les commits pour décider de continuer
          if [ "$latest_commit_gitlab" = "$latest_commit_github" ]; then
            echo "Le dépôt GitLab n'a pas reçu de nouveaux commits. Arrêt du workflow."
            exit 0
          else
            echo "Nouveaux commits détectés. Clonage et synchronisation avec GitHub."
          fi

      - name: Clone GitLab repository
        run: |
          # Cloner le dépôt GitLab public
          git clone https://git.unicaen.fr/open-source/OSE.git
          cd OSE

          # Configurer Git pour l'authentification GitHub
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Rediriger l'origine vers GitHub et pousser les mises à jour
          git remote remove origin
          git remote add origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}
          git push -u origin --all
          git push -u origin --tags
