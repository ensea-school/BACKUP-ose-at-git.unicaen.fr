<?php
/* @var $this Application\View\Renderer\PhpRenderer */
/* @var $context ContextService */

/* @var $documentation string[] */

use Application\Provider\Privilege\Privileges;
use Application\Service\ContextService;

$this->headTitle("Accueil");
echo $this->messenger()
    ->addMessagesFromFlashMessenger() // affichage des messages des namespaces 'info', 'success', 'warning', 'error' comme d'hab
    ->addMessagesFromFlashMessenger('UnicaenAuth/*');

$canAbonne = $this->isAllowed(Privileges::getResourceId(Privileges::INDICATEUR_ABONNEMENT));

$intervenant     = $context->getIntervenant();
$onlyIntervenant = $intervenant && (null == $context->getSelectedIdentityRole()->getDbRole());

?>
    <div class="container-fluid text-sm p-5 jumbotron">
        <h1><span class="appname"><span class="c1">O</span><span class="c2">S</span><span class="c3">E</span></span>
            <small>Organisation des Services d'Enseignement</small>
        </h1>
        <p class="lead"><?= $pageAccueil ?></p>
        <p class="lead">Année <?= $annee ?>.</p>

        <?php
        if ($context->getUtilisateur()) {

            if ($onlyIntervenant) {
                if ($intervenant->getStatut()->isNonAutorise()) {

                    ?><p>
                    <div class='alert alert-danger'> <?= $connexionNonAutorise ?></div></p><?php
                } else {
                    echo $this->tag('div')->html($this->feuilleDeRoute($intervenant)->renderCurrentBtn());


                    /* Guide à télécharger... */
                    $guideType = $intervenant->getStatut()->estVacataire() ? 'vacataires' : 'permanents';
                    if (!empty($documentation[$guideType])) {
                        echo $this->tag('div', ['class' => 'alert alert-info', 'style' => 'margin-top:1em', 'role' => 'alert'])->html(
                            'Un guide d\'utilisation de OSE vous est proposé. Vous pouvez le télécharger en suivant le lien ci-contre : '
                            . $this->tag('a', ['target' => '__blank', 'href' => $documentation[$guideType]])->html(
                                $this->tag('span', ['class' => 'fas fa-book'])->openClose() . ' Guide d\'utilisation'
                            )
                        );
                    }
                }
            } elseif ($context->getUtilisateur()->getAffectation()->count() == 0) {
                ?>
                <div class="alert alert-danger" role="alert">
                    <?= $connexionSansRoleNiStatut ?>
                </div>
                <?php
            }
        } else {

            ?><a class="btn btn-success btn-large"
                 href="<?= $this->url('zfcuser/login') ?>"><?= $this->translate('Connectez-vous...') ?></a><?php
        }
        ?>
    </div>

    <!-------------------------- Indicateurs (AJAX) -------------------------->
<?php if (isset($this->abonnementsUrl)): ?>
    <script>
        $(function ()
        {
            var url = '<?= $this->abonnementsUrl ?>';
            $(".abonnements").hide();
            $("#abonnements").load(url, [], function ()
            {
                $(".abonnements").fadeIn();
                $(this).hide().fadeIn();
            });
        });
    </script>
    <h2 class="abonnements">
        Vos indicateurs
        <?php if ($canAbonne): ?><a class="btn btn-secondary btn-sm float-end" href="<?= $this->url('indicateur') ?>">
                Gérer vos abonnements à des indicateurs
            </a><?php endif; ?>
    </h2>
    <div id="abonnements">
        <div class="loading"></div>
    </div>
<?php endif ?>

    <!----------------------------- Feuille de route --------------------------->
<?php
if ($onlyIntervenant) {
    echo $this->feuilleDeRoute($intervenant);
}
