<?php

namespace Application;

use Application\Entity\Db\Indicateur;
use Application\Entity\Db\NotificationIndicateur;
use Zend\Form\Element\Checkbox;
use Zend\Form\Element\Select;

/**
 * @var $this        \Application\View\Renderer\PhpRenderer
 * @var $indicateurs Indicateur[]
 * @var $abonnements NotificationIndicateur[]
 */

$showAbonnements = true;

$this->headTitle()->append($title = "Indicateurs");

$indics = [];
foreach ($indicateurs as $indicateur) {
    $type   = $indicateur->getType();
    $numero = $indicateur->getNumero();

    if (!isset($indics[$type])) {
        $indics[$type] = [];
    }
    $indics[$type][$numero] = $indicateur;
}

ksort($indics);

$notif = new Select('abonnement');
$notif->setEmptyOption('Aucune');
$notif->setAttribute('class', 'notif');
$notif->setValueOptions(NotificationIndicateur::$frequences);

$inHome = new Checkbox('in-home');
$inHome->setCheckedValue('1');
$inHome->setAttribute('class', 'in-home');
$inHome->setUncheckedValue('0');

$noAbo = new NotificationIndicateur();

?>
<h1 class="page-header"><?php echo $title ?></h1>
<?php foreach ($indics as $categorie => $cIndics): ?>
    <div class="panel panel-default indicateurs">
        <div class="panel-heading"><?php echo $categorie ?></div>
        <table class="table table-bordered table-condensed">
            <thead>
            <tr>
                <th class="numero">N°</th>
                <th class="intitule">Intitulé de l'indicateur</th>
                <?php if ($showAbonnements): ?>
                    <th class="page-accueil">Page d'accueil</th>
                    <th class="notification">Notification par mail</th>
                <?php endif ?>
            </tr>
            </thead>
            <tbody>
            <?php foreach ($cIndics as $indicateur):
                /* @var $indicateur Indicateur */
                $abonnement = isset($abonnements[$indicateur->getId()]) ? $abonnements[$indicateur->getId()] : $noAbo;
                $urlAbonner = $this->url('indicateur/abonner', ['indicateur' => $indicateur->getId()]);
                $urlResult = $this->url('indicateur/result', ['indicateur' => $indicateur->getId()]);

                ?>
                <tr class="indicateur" id="<?php echo $indicateur->getId() ?>"
                    data-url="<?php echo $urlAbonner ?>">

                    <td class="numero">
                        <?php echo $indicateur->getNumero() ?>
                    </td>

                    <td class="intitule">
                        <?php if ($indicateur->getCount()): ?>
                            <a href="<?php echo $urlResult ?>"
                               title="Cliquez pour vous rendre à la page concernée"><?php echo $indicateur->getLibelle() ?></a>
                        <?php else: ?>
                            <?php echo $indicateur->getLibelle() ?>
                        <?php endif ?>
                    </td>

                    <?php if ($showAbonnements): ?>
                        <td class="page-accueil">
                            <?php echo $this->formcheckbox($inHome->setValue($abonnement->getInHome())); ?>
                        </td>
                        <td class="notification">
                            <?php echo $this->formSelect($notif->setValue($abonnement->getFrequence())); ?>
                            <span class="indicateur-info glyphicon glyphicon-info-sign" aria-hidden="true"
                                  data-toggle="tooltip" data-placement="auto" data-html="true"
                                  title="<?php echo $abonnement->getFrequence() ? $abonnement->getExtraInfos() : '' ?>"
                                  style="<?php echo $abonnement->getFrequence() ? '' : 'display: none' ?>"></span>
                        </td>
                    <?php endif ?>
                </tr>
            <?php endforeach; ?>
            </tbody>
        </table>
    </div>
<?php endforeach; ?>