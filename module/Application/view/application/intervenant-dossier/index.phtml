<?php


use Application\Assertion\IntervenantDossierAssertion;

$editIdentite = $this->isAllowed($intervenant, IntervenantDossierAssertion::PRIV_EDIT_IDENTITE);
$editAdresse  = $this->isAllowed($intervenant, IntervenantDossierAssertion::PRIV_EDIT_ADRESSE);
$editContact  = $this->isAllowed($intervenant, IntervenantDossierAssertion::PRIV_EDIT_CONTACT);
$editInsee    = $this->isAllowed($intervenant, IntervenantDossierAssertion::PRIV_EDIT_INSEE);
$editIban     = $this->isAllowed($intervenant, IntervenantDossierAssertion::PRIV_EDIT_IBAN);
$canValider   = $this->isAllowed($intervenant, IntervenantDossierAssertion::PRIV_CAN_VALIDE);
$canValider   = $this->isAllowed($intervenant, IntervenantDossierAssertion::PRIV_CAN_VALIDE);

//$nextEtape    = $validation ? WfEtape::CODE_DONNEES_PERSO_VALIDATION : WfEtape::CODE_DONNEES_PERSO_SAISIE;
$nextEtape = '';
$this->headTitle()->append("Nom intervenant XXX")->append("Données personnelles");
$fieldsets = $form->getFieldsets();
?>
<h1 class="page-header">Données personnelles
    <small><?= $intervenant; ?></small>
</h1>
<?php if ($intervenantDossierValidation): ?>
<div class="bg-success" style="padding:10px;">
    <?php endif; ?>

    <?php


    /**
     * Message Importance des données perso.
     */
    /*if (!$form->getObject()->getId()){
        $msg = "Ces données sont indispensables pour éditer %s contrat et mettre en paiement %s heures d'enseignement.";
        if ($role->getIntervenant()) {
            $this->messenger()->addMessage(sprintf($msg, 'votre', 'vos'), 'warning');
        } else {
            $this->messenger()->addMessage(sprintf($msg, 'le', 'les'), 'warning');
        }
    }*/


    echo $this->messenger()->addCurrentMessagesFromFlashMessenger()->addMessagesFromFlashMessenger();

    echo $this->form()->openTag($form);
    ?>
    <div class="row">

        <div class="col-md-12">
            <?php
            echo $this->formControlGroup($form->get('statut'));
            ?>
        </div>
    </div>

    <h3>Identité</h3>
    <div class="row">
        <?php
        if ($editIdentite) {
            echo $this->partial('application/intervenant-dossier/partial/formIdentite', compact('form', 'intervenant', 'intervenantDossier'));
        } else {
            echo $this->partial('application/intervenant-dossier/partial/formIdentiteView', compact('form', 'intervenant', 'intervenantDossier'));
        }
        ?>
    </div>
    <div class="row">
        <?php
        if ($editAdresse) {
            echo $this->partial('application/intervenant-dossier/partial/formAdresse', compact('form', 'intervenant', 'intervenantDossier'));
        } else {
            echo $this->partial('application/intervenant-dossier/partial/formAdresseView', compact('form', 'intervenant', 'intervenantDossier'));
        }
        if ($editContact) {
            echo $this->partial('application/intervenant-dossier/partial/formContact', compact('form', 'intervenant', 'intervenantDossier'));
        } else {
            echo $this->partial('application/intervenant-dossier/partial/formContactView', compact('form', 'intervenant', 'intervenantDossier'));
        }
        ?>
    </div>
    <div class="row">
        <?php
        if ($editInsee) {
            echo $this->partial('application/intervenant-dossier/partial/formInsee', compact('form', 'intervenant', 'intervenantDossier'));
        } else {
            echo $this->partial('application/intervenant-dossier/partial/formInseeView', compact('form', 'intervenant', 'intervenantDossier'));
        }
        if ($editIban) {
            echo $this->partial('application/intervenant-dossier/partial/formBancaire', compact('form', 'intervenant', 'intervenantDossier'));
        } else {
            echo $this->partial('application/intervenant-dossier/partial/formBancaireView', compact('form', 'intervenant', 'intervenantDossier'));
        }
        ?>
    </div>
    <div class="row">
        <?php
        echo $this->partial('application/intervenant-dossier/partial/formEmployeur', compact('form', 'intervenant', 'intervenantDossier'));
        echo $this->partial('application/intervenant-dossier/partial/formAutres', compact('form', 'intervenant', 'intervenantDossier'));
        ?>
    </div>
    <div class="row">
        <div class="col-md-12">
            <?php
            echo $this->formHidden($this->form->get('security'));
            if ($privileges['edit']) {
                echo $this->formSubmit($form->get('submit'));
            }

            ?>
            <?php if ($privileges['valider']): ?>
                <a class="valider-dossier btn btn-success pop-ajax"
                   href="<?= $this->url('intervenant/dossier/valider', [], [], true) ?>"
                   title="Valider les données personnelles"
                   data-content="Confirmez-vous cette validation ?"
                   data-confirm="true"
                   data-confirm-button="Je confirme"
                   data-cancel-button="Non"
                   data-submit-reload="true"
                >
                    <span class="glyphicon glyphicon-thumbs-up"></span> Je valide les données
                </a>
            <?php endif ?>
            <!-- actions de dévalidation du dossier -->
            <?php if ($privileges['devalider']): ?>
                <a class="devalider-dossier btn btn-danger pop-ajax"
                   href="<?= $this->url('intervenant/dossier/devalider', [], [], true) ?>"
                   title="Dévalider les données personnelles"
                   data-content="<p class='lead text-danger'><strong>Attention!</strong> Confirmez-vous cette dévalidation ?</p>"
                   data-confirm="true"
                   data-confirm-button="Oui"
                   data-cancel-button="Non"
                   data-submit-reload="true"
                >
                    <span class="glyphicon glyphicon-thumbs-down"></span> Je dévalide les données
                </a>
            <?php endif ?>
        </div>
    </div>

    <?php
    echo $this->form()->closeTag();
    echo $this->feuilleDeRoute($intervenant)->renderNav($nextEtape);
    ?>
    <?php if ($intervenantDossierValidation): ?>
</div>
<?php endif; ?>
