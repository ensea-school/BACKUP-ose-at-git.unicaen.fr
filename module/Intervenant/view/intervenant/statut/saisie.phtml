<?php

use Application\Provider\Privileges;
use Intervenant\Entity\Db\TypeIntervenant;

/**
 * @var $this              \Application\View\Renderer\PhpRenderer
 * @var $typesIntervenants \Intervenant\Entity\Db\TypeIntervenant[]
 * @var $canEdit           bool
 * @var $statuts           \Intervenant\Entity\Db\Statut[]
 * @var $statut            \Intervenant\Entity\Db\Statut
 * @var $form              \Intervenant\Form\StatutSaisieForm
 * @var $title             string
 */

$this->headTitle()->append($title);

echo $this->form()->openTag($form);
echo $this->formHidden($form->get('id'));
echo $this->messenger()->addCurrentMessagesFromFlashMessenger();

$canAdd = $this->isAllowed(Privileges::getResourceId(Privileges::INTERVENANT_STATUT_EDITION));

?>

<div class="row">
    <div class="col-md-3">
        <?php
        foreach ($typesIntervenants as $typeIntervenant) {
            echo $this->tag('h3')->text($typeIntervenant);
            echo $this->tag('div', ['class' => 'list-group']);
            foreach ($statuts as $s) {
                if ($s->getTypeIntervenant() == $typeIntervenant) {
                    $url    = $this->url('statut/saisie', ['statut' => $s->getId()]);
                    $active = $s == $statut ? ' active' : '';
                    echo $this->tag('a', ['class' => 'list-group-item' . $active,
                                          'href'  => $url])->html($s) . "\n";
                }
            }
            echo '</div>';
        }
        ?>
        <?php if ($canAdd): ?>
            <a class="btn btn-primary" href="<?= $this->url('statut/saisie') ?>" title="Ajouter un statut">
                <span class="fas fa-plus"></span> Ajouter un statut
            </a>
        <?php endif; ?>
    </div>
    <div class="col-md-9">
        <h1><?= $title ?></h1>

        <!-- Informations générales -->
        <div class="card bg-default">
            <div class="card-header">Informations générales</div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <?= $this->formControlGroup($form->get('typeIntervenant')); ?>
                    </div>
                    <div class="col-md-8">
                        <?= $this->formControlGroup($form->get('libelle')); ?>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-4">
                        <?= $this->formControlGroup($form->get('code')); ?>
                    </div>
                    <div class="col-md-4">
                        <?= $this->formControlGroup($form->get('tauxChargesPatronales')); ?>
                    </div>
                    <div class="col-md-4">
                        <?= $this->formControlGroup($form->get('tauxChargesTTC')); ?>
                    </div>
                </div>
                <div class="row">
                    <?php for ($i = 1; $i <= 4; $i++): if ($form->has('codesCorresp' . $i)): ?>
                        <div class="col-md-6">
                            <?= $this->formControlGroup($form->get('codesCorresp' . $i)); ?>
                        </div>
                    <?php endif; endfor; ?>
                </div>
                <?= $this->formControlGroup($form->get('prioritaireIndicateurs')); ?>
            </div>
        </div>


        <!-- Données personnelles -->
        <div class="card bg-default">
            <div class="card-header">Données personnelles</div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-12">
                        <?= $this->formControlGroup($form->get('dossier')); ?>
                    </div>
                </div>
                <div class="donneesDetails">
                    <div class="row">
                        <div class="col-md-12">
                            <?= $this->formControlGroup($form->get('dossierSelectionnable')); ?>
                        </div>
                    </div>
                    <fieldset>
                        <legend>Modules à activer :</legend>


                        <div class="row">
                            <div class="col-md-4">
                                <?= $this->formControlGroup($form->get('dossierStatut')); ?>
                            </div>
                            <div class="col-md-4">
                                <?= $this->formControlGroup($form->get('dossierIdentiteComplementaire')); ?>
                            </div>
                            <div class="col-md-4">
                                <?= $this->formControlGroup($form->get('dossierContact')); ?>
                            </div>

                        </div>
                        <div class="row">
                            <div class="col-md-4">
                                <?= $this->formControlGroup($form->get('dossierAdresse')); ?>
                            </div>
                            <div class="col-md-4">

                                <?= $this->formControlGroup($form->get('dossierBanque')); ?>
                            </div>
                            <div class="col-md-4">
                                <?= $this->formControlGroup($form->get('dossierInsee')); ?>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4">
                                <?= $this->formControlGroup($form->get('dossierEmployeur')); ?>
                            </div>
                        </div>
                    </fieldset>
                    <fieldset class="donneesContactDetails">
                        <legend>Règles spécifiques :</legend>
                        <div class="row">
                            <div class="col-md-12">
                                <?= $this->formControlGroup($form->get('dossierTelPerso')); ?>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12">
                                <?= $this->formControlGroup($form->get('dossierEmailPerso')); ?>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12">
                                <?= $this->formControlGroup($form->get('dossierEmployeurFacultatif')); ?>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12">
                                <?= $this->formControlGroup($form->get('dossierSituationMatrimoniale')); ?>
                            </div>
                        </div>
                    </fieldset>
                    <fieldset>
                        <legend>Autres informations demandées :</legend>
                        <div class="row">
                            <?php for ($i = 1; $i <= 5; $i++): if ($form->has('dossierAutre' . $i)): ?>
                                <div class="col-md-6">
                                    <?= $this->formControlGroup($form->get('dossierAutre' . $i)); ?>
                                </div>
                            <?php endif; endfor; ?>
                        </div>
                    </fieldset>
                </div>
            </div>
        </div>


        <!-- Pièces justificatives -->
        <div class="card bg-default">
            <div class="card-header">Pièces justificatives</div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-12">
                        <?= $this->formControlGroup($form->get('pieceJustificative')); ?>
                        <?php if ($this->isAllowed(Privileges::getResourceId(Privileges::PIECE_JUSTIFICATIVE_GESTION_VISUALISATION))): ?>
                            <a target="_blank"
                               href="<?= $this->url('piece-jointe/type-piece-jointe-statut', ['codeTypeIntervenant' => TypeIntervenant::CODE_EXTERIEUR]); ?>">
                                Page d'administration des pièces justificatives
                            </a>
                        <?php endif; ?>
                    </div>
                </div>
            </div>
        </div>


        <!-- Services -->
        <div class="card bg-default">
            <div class="card-header">Services d'enseignement</div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <?= $this->formControlGroup($form->get('servicePrevu')); ?>
                    </div>
                    <div class="col-md-6">
                        <?= $this->formControlGroup($form->get('serviceRealise')); ?>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <?= $this->formControlGroup($form->get('modeEnseignementPrevisionnel')); ?>
                    </div>
                    <div class="col-md-6">
                        <?= $this->formControlGroup($form->get('modeEnseignementRealise')); ?>
                    </div>
                </div>

                <div class="row servicesDetails">
                    <div class="col-md-12">
                        <?= $this->formControlGroup($form->get('serviceExterieur')); ?>
                    </div>
                </div>
            </div>
        </div>


        <!-- Référentiel -->
        <div class="card bg-default">
            <div class="card-header">Référentiel</div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <?= $this->formControlGroup($form->get('referentielPrevu')); ?>
                    </div>
                    <div class="col-md-6">
                        <?= $this->formControlGroup($form->get('referentielRealise')); ?>
                    </div>
                </div>
            </div>
        </div>


        <!-- Missions -->
        <div class="card bg-default">
            <div class="card-header">Missions</div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <?= $this->formControlGroup($form->get('mission')); ?>
                    </div>
                    <div class="col-md-6">
                        <?= $this->formControlGroup($form->get('missionIndemnitees')); ?>
                    </div>

                </div>
                <div class="row missionDetails">
                    <div class="col-md-6">
                        <?= $this->formControlGroup($form->get('offreEmploiPostuler')); ?>
                    </div>
                    <div class="col-md-6">
                        <?= $this->formControlGroup($form->get('missionRealise')); ?>
                    </div>
                </div>
                <div class="row missionDecret">
                    <div class="col-md-12">
                        <?= $this->formControlGroup($form->get('missionDecret')); ?>
                    </div>

                </div>

            </div>
        </div>


        <!-- Agréments -->
        <div class="card bg-default">
            <div class="card-header">Agréments</div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <?= $this->formControlGroup($form->get('conseilRestreint')); ?>
                    </div>
                    <div class="col-md-6 agrementCRDetails">
                        <?= $this->formControlGroup($form->get('conseilRestreintDureeVie')); ?>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <?= $this->formControlGroup($form->get('conseilAcademique')); ?>
                    </div>
                    <div class="col-md-6 agrementCADetails">
                        <?= $this->formControlGroup($form->get('conseilAcademiqueDureeVie')); ?>
                    </div>
                </div>
            </div>
        </div>


        <!-- Contrat -->
        <div class="card bg-default">
            <div class="card-header">Contrat de travail et avenants</div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-12">
                        <?= $this->formControlGroup($form->get('contrat')); ?>
                        <div class="contratDetails">
                            <?= $this->formControlGroup($form->get('contratEtatSortie')); ?>
                            <?= $this->formControlGroup($form->get('avenantEtatSortie')); ?>
                            <?php if ($this->isAllowed(Privileges::getResourceId(Privileges::ETAT_SORTIE_ADMINISTRATION_VISUALISATION))): ?>
                                <a target="_blank" href="<?= $this->url('etat-sortie'); ?>">Page d'administration des
                                    états de sortie</a>
                            <?php endif; ?>

                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Calcul des heures complémentaires et mises en paiement -->
        <div class="card bg-default">
            <div class="card-header">Calcul des heures complémentaires et mises en paiement</div>
            <div class="card-body">

                <?= $this->formControlGroup($form->get('paiement')); ?>

                <div class="row">
                    <div class="col-md-6">
                        <?= $this->formControlGroup($form->get('serviceStatutaire')); ?>
                    </div>
                    <div class="col-md-6">
                        <?= $this->formControlGroup($form->get('modificationServiceDu')); ?>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <?= $this->formControlGroup($form->get('tauxRemu')); ?>
                    </div>
                </div>

                <?= $this->formControlGroup($form->get('depassementServiceDuSansHC')); ?>
                <?= $this->formControlGroup($form->get('cloture')); ?>
                <?= $this->formControlGroup($form->get('motifNonPaiement')); ?>
                <?= $this->formControlGroup($form->get('formuleVisualisation')); ?>
            </div>
        </div>

        <div class="card bg-default">
            <div class="card-header">Paramètrage de l'extraction paie</div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <?= $this->formControlGroup($form->get('modeCalcul')); ?>
                    </div>
                    <div class="col-md-6 mission-paie">
                        <?= $this->formControlGroup($form->get('modeCalculPrime')); ?>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 mission-paie">
                        <?= $this->formControlGroup($form->get('codeIndemnite')); ?>
                    </div>
                    <div class="col-md-6">
                        <?= $this->formControlGroup($form->get('codeIndemnitePrime')); ?>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <?= $this->formControlGroup($form->get('typePaie')); ?>
                    </div>
                    <div class="col-md-6 mission-paie">
                        <?= $this->formControlGroup($form->get('typePaiePrime')); ?>
                    </div>
                </div>
            </div>
        </div>


        <!-- Plafonds -->
        <div class="card bg-default">
            <div class="card-header">Plafonds</div>
            <?= $this->plafondConfig()->afficher($statut, $canEdit); ?>
            <?php if ($this->isAllowed(Privileges::getResourceId(Privileges::PLAFONDS_VISUALISATION))): ?>
                <div class="card-body"><a target="_blank" href="<?= $this->url('plafond'); ?>">
                        Page d'administration des plafonds
                    </a>
                </div>
            <?php endif; ?>
        </div>


        <!-- Boutons d'actions -->
        <a href="<?= $this->url('statut') ?>" class="btn btn-secondary">
            <i class="fas fa-rotate-left"></i> Retour à la liste des statuts
        </a>
        <?php if ($canEdit): ?>
            <?= $this->formSubmit($form->get('submit')); ?>
            <?php if ($statut->getId()): ?>
                <a class="pop-ajax btn btn-danger" data-event="statut-clone"
                   href="<?= $this->url('statut/delete', ['statut' => $statut->getId()]) ?>"
                   title="Supprimer le statut d'intervenant"
                   data-content="<p class='lead text-danger'><strong>Attention!</strong> Confirmez-vous cette suppression ?</p>"
                   data-confirm="true" data-confirm-button="Oui"
                   data-cancel-button="Non"
                   data-submit-event="statut_delete">
                    <i i="fas fa-trash-can"></i> Supprimer</a>
                <a class="btn btn-warning"
                   href="<?= $this->url('statut/dupliquer', ['statut' => $statut->getId()]) ?>"
                   title="Dupliquer le statut d'intervenant">
                    <i class="fas fa-rotate-right"></i> Dupliquer</a>
            <?php endif; ?>
            <a href="<?= $this->url('plafond/construire-calculer') ?>" class="btn btn-info pop-ajax">Construction &
                calcul de tous les plafonds</a>
        <?php endif; ?>

        <?= $this->form()->closeTag(); ?>

    </div>

</div>

<script type="text/javascript">
    $(function () {
        $("body").on("statut_delete", function (event, popAjax) {
            window.location.href = '<?= (string)$this->url('statut'); ?>';
        });


        WidgetInitializer.add('statut', {

            donneesVisu: function () {
                var visible = this.el('dossier').val() != 'desactive';

                this.element.find('.donneesDetails').toggle(visible);
            },


            servicesVisu: function () {
                var visible = !(this.el('servicePrevu').val() == 'desactive' && this.el('serviceRealise').val() == 'desactive');

                this.element.find('.servicesDetails').toggle(visible);
            },

            agrementCRVisu: function () {
                var visible = this.el('conseilRestreint').val() != 'desactive';

                this.element.find('.agrementCRDetails').toggle(visible);
            },

            agrementCAVisu: function () {
                var visible = this.el('conseilAcademique').val() != 'desactive';

                this.element.find('.agrementCADetails').toggle(visible);
            },

            contratVisu: function () {
                var visible = this.el('contrat').val() != 'desactive';

                this.element.find('.contratDetails').toggle(visible);
            },

            missionVisu: function () {
                var visible = this.el('mission').val() != 'desactive';
                this.element.find('.missionDetails').toggle(visible);
                this.element.find('.mission-paie').toggle(visible);
                this.element.find('.missionDecret').toggle(visible);
            },

            _create: function () {
                var that = this;

                that.donneesVisu();
                that.donneesContactVisu();
                that.servicesVisu();
                that.agrementCRVisu();
                that.agrementCAVisu();
                that.contratVisu();
                that.missionVisu();

                that.el('dossier').change(function () {
                    that.donneesVisu()
                });
                that.el('dossierContact').change(function () {
                    that.donneesContactVisu()
                });
                that.el('servicePrevu').change(function () {
                    that.servicesVisu()
                });
                that.el('serviceRealise').change(function () {
                    that.servicesVisu()
                });
                that.el('conseilRestreint').change(function () {
                    that.agrementCRVisu()
                });
                that.el('conseilAcademique').change(function () {
                    that.agrementCAVisu()
                });
                that.el('contrat').change(function () {
                    that.contratVisu()
                });
                that.el('mission').change(function () {
                    that.missionVisu()
                });
            },


            el: function (name) {
                return this.element.find('[name=' + name + ']');
            }
        });
    });
</script>