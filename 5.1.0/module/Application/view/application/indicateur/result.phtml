<?php

use Application\Provider\Privilege\Privileges;

/**
 * @var $this       \Application\View\Renderer\PhpRenderer
 * @var $indicateur \Application\Entity\Db\Indicateur
 */

$this->headTitle()->append((string)$this->indicateur);

$result = $indicateur->getResult();

$url = $indicateur->getRoute();
if ($this->isAllowed(Privileges::getResourceId(Privileges::INDICATEUR_ENVOI_MAIL_INTERVENANTS))){
    $mailUrl = $this->url('indicateur/envoi-mail-intervenants', ['indicateur' => $indicateur->getId()]);
}else{
    $mailUrl = null;
}


$hasDetails = false;
foreach($result as $r ){
    if ($r->getDetails()){
        $hasDetails = true;
        break;
    }
}

echo $this->messenger()->addMessagesFromFlashMessenger(); // pour les envois de mail!!

?>
<h1 class="page-header"><?php echo $indicateur->getLibelle() ?>
    <small><?php echo $indicateur ?></small>
</h1>

<div style="margin:1em">
    <div class="indicateurs-result">
        <small><a href="javascript:cocherTout()">Cocher tout</a> / <a href="javascript:decocherTout()">Décocher tout</a></small>
        <table class="table table-bordered table-condensed table-hover">
            <thead>
            <tr>
                <?php if ($mailUrl): ?>
                <th>&nbsp;</th>
                <?php endif; ?>
                <th>Composante</th>
                <th>Intervenant</th>
                <?php if ($hasDetails): ?>
                    <th>Détails</th>
                <?php endif; ?>
            </tr>
            </thead>
            <tbody>
            <?php foreach ($result as $r): ?>
                <tr>
                    <?php if ($mailUrl): ?>
                    <th class="cc"><input type="checkbox" checked="checked" value="<?php echo $r->getIntervenant()->getId() ?>"
                                          class="indic-intervenant"/></th>
                    <?php endif; ?>
                    <td><?php echo $r->getStructure() ?></td>
                    <td>
                        <a href="<?php echo $this->url($indicateur->getRoute(), $r->getUrlParams()) ?>">
                            <?php echo $r->getIntervenant() . ' <small>(n°' . $r->getIntervenant()->getCode() . ')</small>' ?>
                        </a>
                    </td>
                    <?php if ($hasDetails): ?>
                        <td>
                        <?php echo $r->getDetails() ?>
                        </td>
                    <?php endif; ?>
                </tr>
            <?php endforeach; ?>
            </tbody>
        </table>
        <small><a href="javascript:cocherTout()">Cocher tout</a> / <a href="javascript:decocherTout()">Décocher tout</a></small>
    </div>

    <a class="btn btn-default" href="<?php echo $this->url('indicateur'); ?>">
        <i class="fa fa-undo" aria-hidden="true"></i>
        Retour à la liste des indicateurs
    </a>
    <?php if ($mailUrl): ?>
    <a id="send-mail-link"
       class="btn btn-primary"
       href="javascript:envoiMail()">Rédiger un mail pour les intervenants sélectionnés...</a>
    <?php endif; ?>
</div>
<?php if ($mailUrl): ?>
<script>

    function cocherTout(){
        $(".indic-intervenant").prop("checked", true);
    }


    function decocherTout() {
        $(".indic-intervenant").prop("checked", false);
    }

    function envoiMail(){
        var url = <?php echo json_encode( $mailUrl ) ?>;
        var ids = '';
        $(".indic-intervenant:checked").each(function(){

            if (ids != '') ids += '-';
            ids += $(this).val();

        });

        url += '?intervenants=' + ids;

        window.location.href = url;
    }

</script>
<?php endif; ?>