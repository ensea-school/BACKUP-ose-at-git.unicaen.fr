#!/usr/bin/env php
<?php

require __DIR__ . '/../vendor/autoload.php';

// Autochargement de fichiers supplÃ©mentaires pour OseAdmin
spl_autoload_register(function ($class){

    $dirs = [
        dirname(__DIR__) . '/admin/src/'       => null,
        dirname(__DIR__) . '/admin/actul/src/' => null,
    ];
    foreach ($dirs as $dir => $ns) {
        if (!$ns || str_starts_with($class, $ns)) {
            $filename = $dir . str_replace('\\', '/', $class) . '.php';

            if (file_exists($filename)) {
                require_once $filename;
                break;
            }
        }
    }
});

// Fix PATH problems
chdir(dirname(__DIR__));
$console = new \Symfony\Component\Console\Application();
$conf    = require __DIR__ . '/../config/application.config.php';
$app     = Laminas\Mvc\Application::init($conf);


$commands = [];
// On parse automatiquement le dossier des commandes
$modules = $conf['modules'];


function scanCommandFiles($modules)
{
    $path = __DIR__ . '/../module';

    foreach ($modules as $module) {
        $dir = $modulePath = __DIR__ . '/../module/' . $module . '/src/Command';
        if (is_dir($dir)) {
            global $app;
            $output = [];
            $re     = '/.*Command\.php/m';
            $scan   = scandir($dir);
            foreach ($scan as $key => $value) {
                if (!in_array($value, ['.', '..'])) {
                    if (preg_match($re, $value, $matches)) {
                        $class     = substr($value, 0, strlen($value) - 4);
                        $reflector = new ReflectionClass($module . '\Command\\' . $class);
                        if ($reflector->isSubclassOf(\Symfony\Component\Console\Command\Command::class)) {
                            $result[] = $reflector->newInstanceArgs([$app->getServiceManager(), OseAdmin::instance()]);
                        }
                    }
                }
            }
        }
    }

    return $result;
}


$commands = scanCommandFiles($modules);
$console->addCommands($commands);

$console->run();
