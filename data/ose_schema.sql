
CREATE SEQUENCE UTILISATEUR_ID_seq INCREMENT BY 1 START WITH 1 NOCACHE NOORDER NOCYCLE ;

-- trigger 
CREATE OR REPLACE TRIGGER type_structure_changes
  BEFORE UPDATE ON type_structure
  FOR EACH ROW
DECLARE
    v_historique_id number;
BEGIN
    if (:new.historique_id is null) then -- historique_id null : improbable!
      --select historique_id_seq.nextval into v_historique_id from dual;
      --insert into historique (id, debut, modification, createur, modificateur) values (v_historique_id, sysdate, sysdate, ose_historique.get_current_user(), ose_historique.get_current_user());
      select OSE_HISTORIQUE.CREATE_HISTORIQUE_ID into v_historique_id from dual;
      update type_structure set historique_id = v_historique_id;
    else
      update historique set modification = sysdate, modificateur = ose_historique.get_current_user() where id = :new.historique_id;
    end if;
END;
/

-- generation des triggers
 select distinct 'CREATE OR REPLACE TRIGGER ' || TABLE_NAME || '_UPDATE ' || '
  BEFORE UPDATE ON ' || TABLE_NAME || '
  FOR EACH ROW
DECLARE
    v_historique_id number;
BEGIN
    if (:new.historique_id is null) then -- historique_id null : improbable!
      --select historique_id_seq.nextval into v_historique_id from dual;
      --insert into historique (id, debut, modification, createur, modificateur) values (v_historique_id, sysdate, sysdate, ose_historique.get_current_user(), ose_historique.get_current_user());
      select OSE_HISTORIQUE.CREATE_HISTORIQUE_ID into v_historique_id from dual;
      update ' || TABLE_NAME || ' set historique_id = v_historique_id;
    else
      update historique set modification = sysdate, modificateur = ose_historique.get_current_user() where id = :new.historique_id;
    end if;
END;
/
'
from ALL_TAB_COLUMNS where owner = 'OSE' and column_name = 'HISTORIQUE_ID';




-- test fonction et trigger historique

delete from TYPE_STRUCTURE;
delete from HISTORIQUE;
delete from "USER";
insert into "USER" (ID, USERNAME, EMAIL, DISPLAY_NAME, PASSWORD, STATE) values (1, 'gauthierb', 'bertrand.gauthier@unicaen.Fr', 'Beber', 'ldap', 1) ;
insert into "USER" (ID, USERNAME, EMAIL, DISPLAY_NAME, PASSWORD, STATE) values (2, 'lecluse', 'lecluse@unicaen.Fr', 'Lolo', 'ldap', 1) ; 

BEGIN ose_historique.set_current_user(1); END;
/
insert into TYPE_STRUCTURE( ID, LIBELLE, HISTORIQUE_ID) values (1, 'Test bertrand', OSE_HISTORIQUE.CREATE_HISTORIQUE_ID);
select * from TYPE_STRUCTURE;
select * from HISTORIQUE;

BEGIN ose_historique.set_current_user(2); END;
/
update TYPE_STRUCTURE set LIBELLE = 'Test 2' where id = 1;
select * from TYPE_STRUCTURE;
select * from HISTORIQUE;
commit;




 
 
 CREATE OR REPLACE  VIEW "HARP_ADM"."UNICAEN_V_AFFECTATION" AS 
  SELECT aa.NO_DOSSIER_PERS,
  aa.C_STRUCTURE,
  NIVEAU_STRUCTURE(aa.C_STRUCTURE) as niveau,
  -- NB: si p.C_STRUCTURE est null alors l'individu n'a qu'une seule affectation
  case when p.C_STRUCTURE is null or p.C_STRUCTURE = aa.C_STRUCTURE then 1 else 0 end as principale,
  0 as recherche,
  aa.D_DEB_AFFECTATION,
  aa.D_FIN_AFFECTATION
FROM AFFECTATION aa
inner join PERSONNEL p on p.NO_DOSSIER_PERS = aa.NO_DOSSIER_PERS
union
SELECT ar.NO_DOSSIER_PERS,
  ar.C_STRUCTURE,
  NIVEAU_STRUCTURE(ar.C_STRUCTURE) as niveau,
  0 as principale,
  1 as recherche,
  ar.D_DEB_AFFE_RECH as D_DEB_AFFECTATION,
  ar.D_FIN_AFFE_RECH as D_FIN_AFFECTATION
FROM AFFECTATION_RECHERCHE ar
union
SELECT ch.NO_INDIVIDU,
  ch.C_STRUCTURE,
  NIVEAU_STRUCTURE(ch.C_STRUCTURE) as niveau,
  0 as principale,
  0 as recherche,
  ch.D_DEB_STR_TRAV as D_DEB_AFFECTATION,
  ch.D_FIN_STR_TRAV as D_FIN_AFFECTATION
FROM CHERCHEUR ch;


select NO_DOSSIER_PERS, count(C_STRUCTURE) 
from (
  select NO_DOSSIER_PERS, 
    C_STRUCTURE, 
    niveau,
    principale, 
    sum(principale) over(partition by NO_DOSSIER_PERS) nb_aff,
    row_number() over(partition by NO_DOSSIER_PERS order by niveau, D_DEB_AFFECTATION) row_num,
    case when sum(principale) over(partition by NO_DOSSIER_PERS) > 1 and row_number() over(partition by NO_DOSSIER_PERS order by niveau, D_DEB_AFFECTATION) = 1 then principale else 0 end as principale,
    recherche, 
    D_DEB_AFFECTATION, 
    D_FIN_AFFECTATION 
  from UNICAEN_V_AFFECTATION
  where sysdate between D_DEB_AFFECTATION and nvl(D_FIN_AFFECTATION, sysdate) 
  and NO_DOSSIER_PERS in (1602,25062,5494,442)
)
where principale=1 and sysdate between D_DEB_AFFECTATION and nvl(D_FIN_AFFECTATION, sysdate) 
group by NO_DOSSIER_PERS
having count(C_STRUCTURE) > 1;


select * from V_HARP_AFFECTATION where NO_DOSSIER_PERS in (
1602,
25062,
5494,
442)
and principale=1 and sysdate between D_DEB_AFFECTATION and nvl(D_FIN_AFFECTATION, sysdate) ;

-- individus ayant plusieurs affectations principales
select NO_DOSSIER_PERS, count(C_STRUCTURE) 
from v_harp_affectation 
where principale=1 and sysdate between D_DEB_AFFECTATION and nvl(D_FIN_AFFECTATION, sysdate) 
group by NO_DOSSIER_PERS
having count(C_STRUCTURE) > 1;

-- individus n'ayant aucune affectation principale
select NO_DOSSIER_PERS, sum(principale) 
from UNICAEN_V_AFFECTATION 
where sysdate between D_DEB_AFFECTATION and nvl(D_FIN_AFFECTATION, sysdate) 
group by NO_DOSSIER_PERS
having sum(principale) = 0;


select 'azertyuiopqsdfghjklmwxcvbné"''(-è_çà)=1234567890°+$ù£%!:;,§/.?<>²¹~#{[|`\^@]}¤''" AZERTYUIOPQSDFGHJKLMWXCVBNÉ"''(-È_ÇÀ)=1234567890°+$Ù£%!:;,§/.?<>²¹~#{[|`\^@]}¤''"' test from dual;
select convert('azertyuiopqsdfghjklmwxcvbné"''(-è_çà)=1234567890°+$ù£%!:;,§/.?<>²¹~#{[|`\^@]}¤''" AZERTYUIOPQSDFGHJKLMWXCVBNÉ"''(-È_ÇÀ)=1234567890°+$Ù£%!:;,§/.?<>²¹~#{[|`\^@]}¤''"', 'US7ASCII', 'AL32UTF8') test from dual;


CREATE SEQUENCE ADRESSE_INTERVENANT_ID_SEQ INCREMENT BY 1 START WITH 1 NOCACHE NOORDER NOCYCLE ;
CREATE SEQUENCE ADRESSE_STRUCTURE_ID_SEQ INCREMENT BY 1 START WITH 1 NOCACHE NOORDER NOCYCLE ;
CREATE SEQUENCE AGREMENT_ID_SEQ INCREMENT BY 1 START WITH 1 NOCACHE NOORDER NOCYCLE ;
--CREATE SEQUENCE ANNEE_ID_SEQ INCREMENT BY 1 START WITH 1 NOCACHE NOORDER NOCYCLE ;
--CREATE SEQUENCE BIS_TER_ID_SEQ INCREMENT BY 1 START WITH 1 NOCACHE NOORDER NOCYCLE ;
CREATE SEQUENCE CHEMIN_PEDAGOGIQUE_ID_SEQ INCREMENT BY 1 START WITH 1 NOCACHE NOORDER NOCYCLE ;
--CREATE SEQUENCE CIVILITE_ID_SEQ INCREMENT BY 1 START WITH 1 NOCACHE NOORDER NOCYCLE ;
CREATE SEQUENCE COMPTE_BANCAIRE_ID_SEQ INCREMENT BY 1 START WITH 1 NOCACHE NOORDER NOCYCLE ;
CREATE SEQUENCE CORPS_ID_SEQ INCREMENT BY 1 START WITH 1 NOCACHE NOORDER NOCYCLE ;
CREATE SEQUENCE DIPLOME_ID_SEQ INCREMENT BY 1 START WITH 1 NOCACHE NOORDER NOCYCLE ;
CREATE SEQUENCE DIPLOME_ETAPE_ID_SEQ INCREMENT BY 1 START WITH 1 NOCACHE NOORDER NOCYCLE ;
CREATE SEQUENCE ELEMENT_PEDAGOGIQUE_ID_SEQ INCREMENT BY 1 START WITH 1 NOCACHE NOORDER NOCYCLE ;
CREATE SEQUENCE EMPLOI_ID_SEQ INCREMENT BY 1 START WITH 1 NOCACHE NOORDER NOCYCLE ;
CREATE SEQUENCE EMPLOYEUR_ID_SEQ INCREMENT BY 1 START WITH 1 NOCACHE NOORDER NOCYCLE ;
CREATE SEQUENCE ETABLISSEMENT_ID_SEQ INCREMENT BY 1 START WITH 1 NOCACHE NOORDER NOCYCLE ;
CREATE SEQUENCE ETAPE_ID_SEQ INCREMENT BY 1 START WITH 1 NOCACHE NOORDER NOCYCLE ;
CREATE SEQUENCE FONCTION_REFERENTIEL_ID_SEQ INCREMENT BY 1 START WITH 1 NOCACHE NOORDER NOCYCLE ;
CREATE SEQUENCE INTERVENANT_ID_SEQ INCREMENT BY 1 START WITH 1 NOCACHE NOORDER NOCYCLE ;
--CREATE SEQUENCE INTERVENANT_EXTERIEUR_ID_SEQ INCREMENT BY 1 START WITH 1 NOCACHE NOORDER NOCYCLE ;
--CREATE SEQUENCE INTERVENANT_PERMANENT_ID_SEQ INCREMENT BY 1 START WITH 1 NOCACHE NOORDER NOCYCLE ;
CREATE SEQUENCE INTERVENANT_SECTION_CNU_ID_SEQ INCREMENT BY 1 START WITH 1 NOCACHE NOORDER NOCYCLE ;
CREATE SEQUENCE MOTIF_NON_PAIEMENT_ID_SEQ INCREMENT BY 1 START WITH 1 NOCACHE NOORDER NOCYCLE ;
CREATE SEQUENCE PERIODE_ID_SEQ INCREMENT BY 1 START WITH 1 NOCACHE NOORDER NOCYCLE ;
CREATE SEQUENCE PERIODE_TYPE_ID_SEQ INCREMENT BY 1 START WITH 1 NOCACHE NOORDER NOCYCLE ;
CREATE SEQUENCE PERSONNEL_ID_SEQ INCREMENT BY 1 START WITH 1 NOCACHE NOORDER NOCYCLE ;
CREATE SEQUENCE PIECE_JOINTE_ID_SEQ INCREMENT BY 1 START WITH 1 NOCACHE NOORDER NOCYCLE ;
CREATE SEQUENCE PRIME_EXCELLENCE_SCIENT_ID_SEQ INCREMENT BY 1 START WITH 1 NOCACHE NOORDER NOCYCLE ;
--CREATE SEQUENCE REGIME_SECU_ID_SEQ INCREMENT BY 1 START WITH 1 NOCACHE NOORDER NOCYCLE ;
CREATE SEQUENCE ROLE_ID_SEQ INCREMENT BY 1 START WITH 1 NOCACHE NOORDER NOCYCLE ;
CREATE SEQUENCE SECTION_CNU_ID_SEQ INCREMENT BY 1 START WITH 1 NOCACHE NOORDER NOCYCLE ;
CREATE SEQUENCE SERVICE_ID_SEQ INCREMENT BY 1 START WITH 1 NOCACHE NOORDER NOCYCLE ;
CREATE SEQUENCE SERVICE_REFERENTIEL_ID_SEQ INCREMENT BY 1 START WITH 1 NOCACHE NOORDER NOCYCLE ;
CREATE SEQUENCE SITUATION_FAMILIALE_ID_SEQ INCREMENT BY 1 START WITH 1 NOCACHE NOORDER NOCYCLE ;
CREATE SEQUENCE STRUCTURE_ID_SEQ INCREMENT BY 1 START WITH 1 NOCACHE NOORDER NOCYCLE ;
CREATE SEQUENCE TYPE_DIPLOME_ID_SEQ INCREMENT BY 1 START WITH 1 NOCACHE NOORDER NOCYCLE ;
CREATE SEQUENCE TYPE_FORMATION_ID_SEQ INCREMENT BY 1 START WITH 1 NOCACHE NOORDER NOCYCLE ;
--CREATE SEQUENCE TYPE_INTERVENANT_ID_SEQ INCREMENT BY 1 START WITH 1 NOCACHE NOORDER NOCYCLE ;
CREATE SEQUENCE TYPE_INTERVENANT_EXTERIEUR_ID_SEQ INCREMENT BY 1 START WITH 1 NOCACHE NOORDER NOCYCLE ;
CREATE SEQUENCE TYPE_INTERVENTION_ID_SEQ INCREMENT BY 1 START WITH 1 NOCACHE NOORDER NOCYCLE ;
CREATE SEQUENCE TYPE_PIECE_JOINTE_ID_SEQ INCREMENT BY 1 START WITH 1 NOCACHE NOORDER NOCYCLE ;
CREATE SEQUENCE TYPE_ROLE_ID_SEQ INCREMENT BY 1 START WITH 1 NOCACHE NOORDER NOCYCLE ;
CREATE SEQUENCE TYPE_ROLE_STRUCTURE_ID_SEQ INCREMENT BY 1 START WITH 1 NOCACHE NOORDER NOCYCLE ;
CREATE SEQUENCE TYPE_STRUCTURE_ID_SEQ INCREMENT BY 1 START WITH 1 NOCACHE NOORDER NOCYCLE ;
CREATE SEQUENCE VOLUME_HORAIRE_ID_SEQ INCREMENT BY 1 START WITH 1 NOCACHE NOORDER NOCYCLE ;

INSERT INTO "OSE"."TYPE_INTERVENANT" (ID, LIBELLE) VALUES (1, 'Permanent');
INSERT INTO "OSE"."TYPE_INTERVENANT" (ID, LIBELLE) VALUES (2, 'Extérieur');

select * from corps;
select * from structure;
select * from intervenant;
select * from INTERVENANT;
select * from INTERVENANT_PERMANENT;
select * from INTERVENANT_EXTERIEUR;
select * from REGIME_SECU;

select 'drop table '||table_name||';' from all_tables where table_name like 'BCP%';

drop table BCP_AGREMENT;
drop table BCP_ANNEE;
drop table BCP_BIS_TER;
drop table BCP_CHEMIN_PEDAGOGIQUE;
drop table BCP_CIVILITE;
drop table BCP_COMPTE_BANCAIRE;
drop table BCP_CORPS;
drop table BCP_DIPLOME;
drop table BCP_DIPLOME_ETAPE;
drop table BCP_ELEMENT_PEDAGOGIQUE;
drop table BCP_EMPLOI;
drop table BCP_EMPLOYEUR;
drop table BCP_ETAPE;
drop table BCP_FONCTION_REFERENTIEL;
drop table BCP_INTERVENANT_EXTERIEUR;
drop table BCP_INTERVENANT_PERMANENT;
drop table BCP_INTERVENANT_SECTION_CNU;
drop table BCP_MOTIF_NON_PAIEMENT;
drop table BCP_PERIODE;
drop table BCP_PERIODE_TYPE;
drop table BCP_PERSONNEL;
drop table BCP_PRIME_EXCELLENCE_SCIENTIFI;
drop table BCP_REGIME_SECU;
drop table BCP_SECTION_CNU;
drop table BCP_SERVICE;
drop table BCP_SERVICE_REFERENTIEL;
drop table BCP_SITUATION_FAMILIALE;
drop table BCP_STRUCTURE;
drop table BCP_TYPE_DIPLOME;
drop table BCP_TYPE_INTERVENANT_EXTERIEUR;
drop table BCP_TYPE_INTERVENTION;
drop table BCP_VOLUME_HORAIRE;
drop table BCP_TYPE_INTERVENANT;

