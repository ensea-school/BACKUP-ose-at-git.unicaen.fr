<?php

/* @var $annee \Application\Entity\Db\Annee */
/* @var $intervenant \Application\Entity\Db\Intervenant */
/* @var $form Application\Form\Intervenant\HeuresCompForm */
/* @var $typeVolumeHoraire Application\Entity\Db\TypeVolumeHoraire */
/* @var $etatVolumeHoraire Application\Entity\Db\EtatVolumeHoraire */
/* @var $data array */

$resultat = $intervenant->getUniqueFormuleResultat($annee, $typeVolumeHoraire, $etatVolumeHoraire);
$this->headTitle()->append($intervenant->getNomUsuel())->append("Heures compl.") ?>

<style>
    th { background-color: #eee }
</style>
<h1 class="page-header"><?php echo $intervenant ?> <small><?php echo $intervenant->getType() ?></small></h1>
<?php echo $this->form()->openTag($form->prepare()); ?>
<div class="row">
    <div class="col-sm-4"><?php echo $this->formControlGroup($form->get('type-volume-horaire')); ?></div>
    <div class="col-sm-4"><?php echo $this->formControlGroup($form->get('etat-volume-horaire')); ?></div>
    <div class="col-sm-2"><label>&nbsp;</label><br /><?php echo $this->formRow($form->get('submit')); ?></div>
</div>
<?php echo $this->form()->closeTag(); ?>

<?php if ($intervenant->estPermanent()): ?>
<h2>Service Dû</h2>
<div class="row">
    <div class="col-sm-4">Composante d'affectation</div>
    <div class="col-sm-2 nombre"><?php echo $this->structure( $data['structure-affectation'] )->renderLink() ?></div>
</div>
<div class="row">
    <div class="col-sm-4">Service statutaire</div>
    <div class="col-sm-2 nombre"><?php echo \Common\Util::formattedHeures($data['heures-service-statutaire']) ?></div>
</div>
<div class="row">
    <div class="col-sm-4">- Modifications de service</div>
    <div class="col-sm-2 nombre"><?php echo \Common\Util::formattedHeures($data['heures-modification-service']) ?></div>
</div>
<div class="row">
    <div class="col-sm-4">= Service dû</div>
    <div class="col-sm-2 nombre"><span class="label label-info" style="font-size:12pt"><?php echo \Common\Util::formattedHeures($resultat->getServiceDu()) ?></span></div>
</div>
<?php endif; ?>


<h2>Heures effectives d'enseignement</h2>

<table class="table table-bordered table-condensed table-extra-condensed">
<tr>
    <th rowspan="4">Elément ou établissement</th>
    <th colspan="3">Taux</th>
    <?php if ($data['has-ponderation-service-compl']): ?>
    <th rowspan="4">Majoration FC</th>
    <?php endif; ?>
    <th rowspan="4">Composante d'intervention</th>
    <th style="white-space:nowrap" colspan="<?php echo count($data['types-intervention']); ?>">Types d'intervention</th>
    <th colspan="4">HETD</th>
</tr>
<tr>
    <th rowspan="3">FI</th>
    <th rowspan="3">FA</th>
    <th rowspan="3">FC</th>
    <?php foreach( $data['types-intervention'] as $ti ): ?>
    <th><abbr title="<?php echo $ti->getLibelle() ?>"><?php echo $ti->getCode() ?></abbr></th>
    <?php endforeach; ?>
    <th rowspan="3">Dans le service</th>
    <th colspan="3">Au-delà du service</th>
</tr>
<tr>
    <?php foreach( $data['types-intervention'] as $ti ): ?>
    <td class="nombre"><abbr title="Pondération des heures de services"><?php echo \Common\Util::formattedHeures($ti->getTauxHetdService()) ?></abbr></td>
    <?php endforeach; ?>
    <th rowspan="2"><abbr title="Formation initiale">FI</abbr></th>
    <th rowspan="2"><abbr title="Formation continue">FC</abbr></th>
    <th rowspan="2"><abbr title="Formation continue (heures majorées)">FC Maj.</abbr></th>
</tr>
<tr>
    <?php foreach( $data['types-intervention'] as $ti ): ?>
    <td class="nombre"><abbr title="Pondération des heures au-delà du service"><?php echo \Common\Util::formattedHeures($ti->getTauxHetdComplementaire()) ?></abbr></td>
    <?php endforeach; ?>
</tr>
<?php foreach( $data['services'] as $ls ): ?>
    <tr>
        <td><?php
            if ($ls['service']->getElementPedagogique()){
                echo $this->elementPedagogique( $ls['service']->getElementPedagogique() )->renderLink();
                //echo $service->getService()->getElementPedagogique() ? $service->getService()->getElementPedagogique() : $service->getService()->getEtablissement();
            }else{
                echo $this->etablissement( $ls['service']->getEtablissement() )->renderLink();
            }
        ?></td>
        <td class="nombre"><?php echo \Common\Util::formattedPourcentage($ls['taux-fi']) ?></td>
        <td class="nombre"><?php echo \Common\Util::formattedPourcentage($ls['taux-fa']) ?></td>
        <td class="nombre"><?php echo \Common\Util::formattedPourcentage($ls['taux-fc']) ?></td>
        <?php if ($data['has-ponderation-service-compl']): ?>
        <td class="nombre"><?php echo \Common\Util::formattedHeures($ls['ponderation-service-compl'])?></td>
        <?php endif; ?>
        <td><?php echo $this->structure( $ls['service']->getStructureEns() )->renderLink() ?></td>
        <?php foreach( $data['types-intervention'] as $ti ): ?>
        <td class="nombre">
            <abbr title="Equivalence en HETD : <?php echo isset($ls['hetd'][$ti->getId()]) ? strip_tags(\Common\Util::formattedHeures($ls['hetd'][$ti->getId()])) : null ?>">
                <?php echo isset($ls['heures'][$ti->getId()]) ? \Common\Util::formattedHeures($ls['heures'][$ti->getId()]) : null ?>
            </abbr>
        </td>
        <?php endforeach; ?>
        <td class="nombre"><?php echo \Common\Util::formattedHeures($ls['total-hetd'])?></td>
        <td class="nombre"><?php echo \Common\Util::formattedHeures($ls['total-hetd-compl-fi'])?></td>
        <td class="nombre"><?php echo \Common\Util::formattedHeures($ls['total-hetd-compl-fc'])?></td>
        <td class="nombre"><?php echo \Common\Util::formattedHeures($ls['total-hetd-compl-fc-majorees'])?></td>
    </tr>
<?php endforeach; ?>
</table>

<h2>Heures de référentiel</h2>
<table class="table table-bordered table-condensed table-extra-condensed" style="width:auto">
    <tr>
        <th>Structure</th>
        <th>Heures réelles</th>
        <th><abbr title="Heures Equivalent TD dans le service">HETD service</abbr></th>
        <th><abbr title="Heures Equivalent TD au-delà du service">HETD compl.</abbr></th>
    </tr>
    <?php foreach( $data['referentiel'] as $ref ): ?>
    <tr>
        <td><?php echo $this->structure( $ref['structure'] )->renderLink() ?></td>
        <td class="nombre"><?php echo \Common\Util::formattedHeures($ref['heures']) ?></td>
        <td class="nombre"><?php echo \Common\Util::formattedHeures($ref['hetd']) ?></td>
        <td class="nombre"><?php echo \Common\Util::formattedHeures($ref['hetd-compl']) ?></td>
    </tr>
    <?php endforeach; ?>
</table>

<h2>Totaux HETD</h2>
<div class="row">
    <div class="col-sm-4">Enseignements</div>
    <div class="col-sm-2 nombre"><?php echo \Common\Util::formattedHeures($resultat->getEnseignements()) ?></div>
</div>
<div class="row">
    <div class="col-sm-4">+ référentiel</div>
    <div class="col-sm-2 nombre"><?php echo \Common\Util::formattedHeures($resultat->getReferentiel()) ?></div>
</div>
<div class="row">
    <div class="col-sm-4">= Service assuré</div>
    <div class="col-sm-2 nombre"><span class="label label-info" style="font-size:12pt"><?php echo \Common\Util::formattedHeures($resultat->getServiceAssure()) ?></span></div>
</div>
<div class="row">&nbsp;</div>
<div class="row">
    <div class="col-sm-4"><abbr title="Heures complémentaires (formation initiale)">HC FI</abbr></div>
    <div class="col-sm-2 nombre"><?php echo \Common\Util::formattedHeures($resultat->getHeuresComplFi()) ?></div>
</div>
<div class="row">
    <div class="col-sm-4"><abbr title="Heures complémentaires (formation continue)">HC FC</abbr></div>
    <div class="col-sm-2 nombre"><?php echo \Common\Util::formattedHeures($resultat->getHeuresComplFc()) ?></div>
</div>
<div class="row">
    <div class="col-sm-4"><abbr title="Heures complémentaires (formation continue, heures majorées)">HC FC MAJ</abbr></div>
    <div class="col-sm-2 nombre"><?php echo \Common\Util::formattedHeures($resultat->getHeuresComplFcMajorees()) ?></div>
</div>
<div class="row">
    <div class="col-sm-4"><abbr title="Heures complémentaires (référentiel)">HC Référentiel</abbr></div>
    <div class="col-sm-2 nombre"><?php echo \Common\Util::formattedHeures($resultat->getHeuresComplReferentiel()) ?></div>
</div>
<div class="row">
    <div class="col-sm-4">Solde</div>
    <div class="col-sm-2 nombre"><span class="label label-<?php $hs = $resultat->getHeuresSolde(); if ($hs== 0) echo 'info'; elseif( $hs < 0) echo 'danger'; else echo 'warning'; ?>" style="font-size:12pt"><?php echo \Common\Util::formattedHeures($resultat->getHeuresSolde()) ?></span></div>
</div>