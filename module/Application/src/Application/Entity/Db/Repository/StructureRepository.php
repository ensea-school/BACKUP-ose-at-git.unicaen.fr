<?php

namespace Application\Entity\Db\Repository;

use Doctrine\ORM\EntityRepository;

/**
 * StructureRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 *
 * @author Laurent LÃ‰CLUSE <laurent.lecluse at unicaen.fr>
 */
class StructureRepository extends EntityRepository
{

    /**
     * Recherche par nom
     *
     * @param string $term
     * @return \Application\Entity\Db\Structure[]
     */
    public function findByNom($term)
    {
        $term = str_replace(' ', '', $term);

        $qb = $this->createQueryBuilder('s');

        $libelleLong = new \Doctrine\ORM\Query\Expr\Func('CONVERT', array('s.libelleLong', '?3') );
        $libelleCourt = new \Doctrine\ORM\Query\Expr\Func('CONVERT', array('s.libelleCourt', '?3') );

        $qb
                ->where('s.sourceCode = ?1')
                ->orWhere($qb->expr()->like($qb->expr()->upper($libelleLong), $qb->expr()->upper('CONVERT(?2, ?3)')))
                ->orWhere($qb->expr()->like($qb->expr()->upper($libelleCourt), $qb->expr()->upper('CONVERT(?2, ?3)')))
                ->orderBy('s.libelleCourt');

        $qb->setParameters(array(1 => $term, 2 => "%$term%", 3 => 'US7ASCII'));

        //print_r($qb->getQuery()->getSQL()); var_dump($qb->getQuery()->getParameters());die;

        return $qb->getQuery()->execute();
    }
}