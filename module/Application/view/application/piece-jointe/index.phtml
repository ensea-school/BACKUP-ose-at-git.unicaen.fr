<?php

use Application\Provider\Privilege\Privileges;

/**
 * @var $this         \Application\View\Renderer\PhpRenderer
 * @var $intervenant  \Application\Entity\Db\Intervenant
 * @var $title        string
 * @var $demandees    \Application\Entity\Db\TypePieceJointe[]
 * @var $fournies     \Application\Entity\Db\PieceJointe[]
 * @var $messages     array
 * @var $alertContrat boolean
 */

$this->headTitle()->append($intervenant->getNomComplet())->append("Pièces justificatives");

$canEdit      = $this->isAllowed(Privileges::getResourceId(Privileges::PIECE_JUSTIFICATIVE_EDITION));
$canValider   = $this->isAllowed(Privileges::getResourceId(Privileges::PIECE_JUSTIFICATIVE_VALIDATION));
$canDevalider = $this->isAllowed(Privileges::getResourceId(Privileges::PIECE_JUSTIFICATIVE_DEVALIDATION));

$infosUrl = $this->url('piece-jointe/intervenant/infos', ['intervenant' => $intervenant->getRouteParam()]);

$menuUrl = $this->url('intervenant/services', ['intervenant' => $intervenant->getRouteParam()], ['query' => ['menu' => 1]] );

?>
    <h1 class="page-header"><?= $title ?></h1>

    <div class="piece-jointe">
        <div class="infos" data-url="<?= $infosUrl ?>">
            <?= $this->partial('application/piece-jointe/infos', compact('messages')); ?>
        </div>
        <?php

        $restantes = $fournies;
        if (!empty($demandees)) {
            echo '<div class="well">';
            echo '<h2>Pièces demandées</h2>';
            $obligatoire = true;
            foreach ($demandees as $pj) { // on liste les pièces demandées
                //Check si piece obligatoire
                $obligatoire = $pj->isObligatoire();
                $tpj = $pj->getTypePieceJointe();
                if (isset($fournies[$tpj->getId()])) { // qu'elles soient fournies ou non
                    $pj = $fournies[$tpj->getId()];
                    unset($restantes[$tpj->getId()]);
                } else {
                    $pj = null;
                }
                echo $this->partial('application/piece-jointe/partial/piece-jointe', compact('intervenant', 'tpj', 'pj', 'canEdit', 'canValider', 'canDevalider', 'obligatoire'));
            }
            echo '</div>';

            if ($alertContrat) {
                ?>
                <div id="alert-contrat" class="alert alert-warning" role="alert" style="display:none">
                    <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span
                            aria-hidden="true">&times;</span></button>
                    <p><strong>Information importante</strong></p>
                    <p>Votre saisie est terminée.</p>
                    <p>Votre contrat ne pourra être édité qu'après validation de l'ensemble des pièces justificatives.<br/>
                        Aucun enseignement ne pourra avoir lieu avant la signature du contrat.</p>
                </div>
                <?php
            }
        }

        if (!empty($restantes)) {
            echo '<div class="well">';
            echo '<h2>Autres pièces fournies</h2>';
            $obligatoire = false;
            foreach ($restantes as $tpjId => $pj) { // on liste les pièces fournies mais qui ne sont pas demandées...
                $tpj = $pj->getType();
                echo $this->partial('application/piece-jointe/partial/piece-jointe', compact('intervenant', 'tpj', 'pj', 'canEdit', 'canValider', 'canDevalider', 'obligatoire'));
            }
            echo '</div>';
        }

        ?>
    </div>
    <script>

        $(function(){

            //WidgetInitializer.add('piece-jointe', 'pieceJointe', function(){
            //    WidgetInitializer.includeJs(Url('js/piece_jointe.js'));
            //    WidgetInitializer.includeCss(Url('css/piece_jointe.css'));
            //});

            $('.piece-jointe').pieceJointe({
                'validation-change': function ()
                {
                    // chargement du menu pour faire apparaître ou disparaitre les liens de validation
                    $('#sidebar').load('<?= $menuUrl; ?>');
                },
            });

        });

    </script>
<?php

echo $this->feuilleDeRoute($intervenant)->renderNav(\Application\Entity\Db\WfEtape::CODE_PJ_VALIDATION);