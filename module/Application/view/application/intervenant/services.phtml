<?php

use Application\Entity\Db\WfEtape;
use Application\Provider\Privilege\Privileges;

/**
 * @var $this                \Application\View\Renderer\PhpRenderer
 * @var $intervenant         \Application\Entity\Db\Intervenant
 * @var $typeVolumeHoraire   \Service\Entity\Db\TypeVolumeHoraire
 * @var $cloture             \Application\Entity\Db\Validation|null
 * @var $role                \Application\Acl\Role
 * @var $services            \Application\Entity\Db\Service[]
 * @var $servicesReferentiel \Referentiel\Entity\Db\ServiceReferentiel[]
 */

$service = new \Application\Entity\Db\Service();
$service->setIntervenant($intervenant);
$service->setTypeVolumeHoraire($typeVolumeHoraire);
$canAddService = $this->isAllowed($service, $typeVolumeHoraire->getPrivilegeEnseignementEdition());

$serviceReferentiel = new \Referentiel\Entity\Db\ServiceReferentiel();
$serviceReferentiel->setIntervenant($intervenant);
$serviceReferentiel->setTypeVolumeHoraire($typeVolumeHoraire);
$serviceReferentiel->setStructure($role->getStructure());
$canAddServiceReferentiel = $this->isAllowed($serviceReferentiel, $typeVolumeHoraire->getPrivilegeReferentielEdition());

if ($typeVolumeHoraire->isPrevu()) {
    $nextEtape = WfEtape::CODE_SERVICE_SAISIE;
    $title     = 'Enseignements';
} else {
    $nextEtape = WfEtape::CODE_SERVICE_SAISIE_REALISE;
    $title     = 'Constatation des enseignements réalisés';
}

$menuUrl = $this->url(null, ['intervenant' => $intervenant->getId()], ['query' => ['menu' => 1]]);

$btnNextUrl = $this->url('workflow/feuille-de-route-btn-next', ['intervenant' => $intervenant->getId(), 'wfEtapeCode' => $nextEtape]);

$this->intervenant($intervenant)->renderTitle($title);

echo $this->messenger()->addCurrentMessagesFromFlashMessenger();
echo $this->plafonds($intervenant, $typeVolumeHoraire);

$bottom = false;
if ($cloture) echo $this->partial('application/intervenant/partial/cloture', compact('cloture', 'role', 'bottom'));

/* Services et horodatage */
if ($services !== false) {
    $serviceListe = $this->serviceListe($services);
    $serviceListe->setIntervenant($intervenant);
    $serviceListe->setTypeVolumeHoraire($typeVolumeHoraire)->setAddButtonVisibility($canAddService);
    if ($canAddService && $typeVolumeHoraire->isPrevu()) {
        $serviceListe->showPrevuToPrevu($intervenant);
    }
    echo $serviceListe->render();

    echo $this->partial('application/intervenant/partial/horodatage', [
        'intervenant'       => $intervenant,
        'typeVolumeHoraire' => $typeVolumeHoraire,
        'referentiel'       => false,
    ]);
}

/* Référentiel et horodatage */
if ($servicesReferentiel !== false) {
    $serviceReferentielListe = $this->serviceReferentielListe($servicesReferentiel);
    $serviceReferentielListe->setTypeVolumeHoraire($typeVolumeHoraire)->setAddButtonVisibility($canAddServiceReferentiel);
    if ($canAddServiceReferentiel && $typeVolumeHoraire->isPrevu()) {
        $serviceReferentielListe->showPrevuToPrevu($intervenant);
    }
    echo '<h1>Référentiel</h1><hr />';
    echo $serviceReferentielListe->render();

    echo $this->partial('application/intervenant/partial/horodatage', [
        'intervenant'       => $intervenant,
        'typeVolumeHoraire' => $typeVolumeHoraire,
        'referentiel'       => true,
    ]);
}

$bottom = true;
if ($cloture) echo $this->partial('application/intervenant/partial/cloture', compact('cloture', 'role', 'bottom'));


echo $formuleTotauxHetd;

?>

    <hr/>
    <div id="feuille-de-route-btn-next" data-url="<?= $btnNextUrl ?>">
        <?= $this->feuilleDeRoute($intervenant)->renderNav($nextEtape); ?>
    </div>

<?php if ($services !== false || $servicesReferentiel !== false): ?>
    <script>

        $(function ()
        {
            WidgetInitializer.includeJs(Url('js/service.js'));
            WidgetInitializer.includeJs(Url('js/service-referentiel.js'));
            WidgetInitializer.includeCss(Url('css/service.css'));

            <?php if ($services !== false): ?>$('.service-liste').serviceListe({
                'heures-change-exists': function ()
                {

                },
                'heures-change': function ()
                {
                    // on met à jour le résultat de la formule
                    $("#formule-totaux-hetd").refresh(); // HETD rafraichis

                    // on met à jour l'horodatage des services !!
                    $("#s-horodatage").refresh();

                    // Mise à jour des plafonds
                    $(".plafonds").refresh();

                    // chargement du menu pour faire apparaître ou disparaitre les liens de validation
                    $('#sidebar').load('<?= $menuUrl; ?>');

                    // rafraichissement du bouton de la feuille de route pour pointer vers la prochaine bonne étape
                    $('#feuille-de-route-btn-next').refresh();
                }
            });<?php endif; ?>


            <?php if ($servicesReferentiel !== false): ?>$('.service-referentiel-liste').serviceReferentielListe({
                'heures-change-exists': function ()
                {

                },
                'heures-change': function ()
                {
                    // on met à jour le résultat de la formule
                    $("#formule-totaux-hetd").refresh(); // HETD rafraichis

                    // on met à jour l'horodatage des services !!
                    $("#sr-horodatage").refresh();

                    // Mise à jour des plafonds
                    $(".plafonds").refresh();

                    // chargement du menu pour faire apparaître ou disparaitre les liens de validation
                    $('#sidebar').load('<?= $menuUrl; ?>');

                    // rafraichissement du bouton de la feuille de route pour pointer vers la prochaine bonne étape
                    $('#feuille-de-route-btn-next').refresh();
                }
            });<?php endif; ?>

        });

    </script>
<?php endif; ?>