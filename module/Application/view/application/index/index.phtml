<?php
/* @var $this Application\View\Renderer\PhpRenderer */
/* @var $intervenant \Intervenant\Entity\Db\Intervenant|null */
/* @var $utilisateur \Utilisateur\Entity\Db\Utilisateur|null */
/* @var $onlyIntervenant bool */
/* @var $noPrivilege bool */


/* @var $documentation string[] */

use Application\Provider\Privileges;
use Unicaen\Framework\Application\Application;

$this->headTitle("Accueil");
echo $this->messenger()
    ->addMessagesFromFlashMessenger() // affichage des messages des namespaces 'info', 'success', 'warning', 'error' comme d'hab
    ->addMessagesFromFlashMessenger('UnicaenAuth/*');

$canAbonne = $this->isAllowed(Privileges::getResourceId(Privileges::INDICATEUR_ABONNEMENT));

?>
    <div class="container-fluid text-sm p-5 jumbotron page-accueil">
        <h1 class="logo"><span class="appname"><span class="c1">O</span><span class="c2">S</span><span
                        class="c3">E</span></span></h1>
        <p class="texte">
        <h1 class="titre">
            <small><?= Application::getInstance()->config()['etablissement']['ose'] ?? 'Organisation des Services d\'Enseignement' ?></small>
        </h1>
        <p class="text-accueil"><?= $pageAccueil ?></p>
        <p class="annee">Année <?= $annee ?>.</p>
        </p>

        <?php
        if ($utilisateur) {
            if ($onlyIntervenant) {
                if ($intervenant->getStatut()->isNonAutorise()) {

                    ?><p>
                    <div class='alert alert-danger'> <?= $connexionNonAutorise ?></div></p><?php
                } else {
                    echo $this->vue('workflow/nav', ['intervenant' => $intervenant->getId()]);

                    /* Guide à télécharger... */
                    $guideType = $intervenant->getStatut()->getTypeIntervenant()->getCode();
                    if (!empty($documentation[$guideType])) {
                        echo $this->tag('div', ['class' => 'alert alert-info', 'style' => 'margin-top:1em', 'role' => 'alert'])->html(
                            'Un guide d\'utilisation de OSE vous est proposé. Vous pouvez le télécharger en suivant le lien ci-contre : '
                            . $this->tag('a', ['target' => '__blank', 'href' => $documentation[$guideType]])->html(
                                $this->tag('span', ['class' => 'fas fa-book'])->openClose() . ' Guide d\'utilisation'
                            )
                        );
                    }
                }
            } elseif ($noPrivilege) {
                ?>
                <div class="alert alert-danger" role="alert">
                    <?= $connexionSansRoleNiStatut ?>
                </div>
                <?php
            }
        } else {

            ?><a class="btn btn-success btn-large"
                 href="<?= $this->url('zfcuser/login') ?>"><?= $this->translate('Connectez-vous...') ?></a><?php
        }
        ?>
    </div>

    <!-------------------------- Indicateurs (AJAX) -------------------------->
<?php if (isset($this->abonnementsUrl)): ?>
    <script>
        $(function () {
            var url = '<?= $this->abonnementsUrl ?>';
            $(".abonnements").hide();
            $("#abonnements").load(url, [], function () {
                $(".abonnements").fadeIn();
                $(this).hide().fadeIn();
            });
        });
    </script>
    <h2 class="abonnements">
        Vos indicateurs
        <?php if ($canAbonne): ?><a class="btn btn-secondary btn-sm float-end" href="<?= $this->url('indicateur') ?>">
                Gérer vos abonnements à des indicateurs
            </a><?php endif; ?>
    </h2>
    <div id="abonnements">
        <div class="loading"></div>
    </div>
<?php endif ?>

    <!----------------------------- Feuille de route --------------------------->
<?php
if ($onlyIntervenant) {
    $urlRefresh = $this->url('workflow/feuille-de-route-refresh', ['intervenant' => $intervenant->getId()]);
    echo $this->vue('workflow/feuille-de-route', ['intervenant' => $intervenant->getId(), 'urlRefresh' => $urlRefresh]);
}
