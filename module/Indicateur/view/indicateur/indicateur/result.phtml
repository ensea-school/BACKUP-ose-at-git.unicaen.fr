<?php

use Application\Provider\Privilege\Privileges;

/**
 * @var $this       \Application\View\Renderer\PhpRenderer
 * @var $indicateur \Indicateur\Entity\Db\Indicateur
 * @var $result     array
 */

$this->headTitle()->append((string)$this->indicateur);

$url = $indicateur->getRoute();
if (count($result) > 0 && $this->isAllowed(Privileges::getResourceId(Privileges::INDICATEUR_ENVOI_MAIL_INTERVENANTS))) {
    $mailUrl = $this->url('indicateur/envoi-mail-intervenants', ['indicateur' => $indicateur->getId()]);
} else {
    $mailUrl = null;
}

echo $this->messenger()->addMessagesFromFlashMessenger(); // pour les envois de mail!!

?>
    <h1 class="page-header"><?= $indicateur->getLibelle(count($result)) ?>
        <small><?= $indicateur ?></small>
    </h1>
    <div style="margin:1em">
        <?php

        if (count($result) > 0):
            $supCols = current($result);
            unset($supCols['annee-id']);
            unset($supCols['statut-libelle']);
            unset($supCols['structure-libelle']);
            unset($supCols['prioritaire']);
            unset($supCols['intervenant-code']);
            unset($supCols['intervenant-code-rh']);
            unset($supCols['intervenant-prenom']);
            unset($supCols['intervenant-nom']);
            unset($supCols['intervenant-email-pro']);
            unset($supCols['intervenant-email-perso']);
            $supCols = array_keys($supCols);

            function printValue($value)
            {
                if (is_array($value)) {
                    echo '<td><ul>';
                    foreach ($value as $val) {
                        echo '<li>' . $val . '</li>';
                    }
                    echo '</ul></td>';
                } elseif ($value) {
                    $dt = DateTime::createFromFormat('Y-m-d H:i:s', $value);
                    if ($dt && $dt->format('Y-m-d H:i:s') === $value) {
                        // C'est une date
                        $dtOrder = $dt->format('ymd');
                        echo '<td data-order="' . $dtOrder . '">';
                        echo $dt->format(\Application\Constants::DATE_FORMAT);
                        echo '</td>';
                    } else {
                        echo '<td>';
                        echo $value;
                        echo '</td>';
                    }
                } else {
                    echo '<td>&nbsp;</td>';
                }
            }

            ?>
            <div class="indicateurs-result">
                <small><a href="javascript:cocherTout()">Cocher tout</a> / <a href="javascript:decocherTout()">Décocher
                        tout</a></small>
                <table class="table table-bordered table-sm table-hover table-sort">
                    <thead>
                    <tr>
                        <?php if ($mailUrl): ?>
                            <th>&nbsp;</th>
                        <?php endif; ?>
                        <th><span title="Public à traiter en priorité">Prioritaire</span></th>
                        <th>Composante</th>
                        <th>Intervenant</th>
                        <?php foreach ($supCols as $supCol): ?>
                            <th><?= $supCol ?></th>
                        <?php endforeach; ?>
                    </tr>
                    </thead>
                    <tbody>
                    <?php foreach ($result as $intervenantId => $r): ?>
                        <tr>
                            <?php if ($mailUrl): ?>
                                <th class="cc"><input type="checkbox" checked="checked" value="<?= $intervenantId ?>"
                                                      class="indic-intervenant"/></th>
                            <?php endif; ?>
                            <td style="text-align: center"><?= $r['prioritaire'] ? '<i class="fas fa-star"></i>' : '' ?></td>
                            <?php printValue($r['structure-libelle']); ?>
                            <td>

                              
                                <a href="<?= $this->url($indicateur->getRoute(), ['intervenant' => $intervenantId]) ?>">
                                    <?php
                                    if (!empty($r['intervenant-code-rh'])) {
                                        echo $r['intervenant-nom'] . ' ' . $r['intervenant-prenom'] . " <small>(n°" . $r['intervenant-code-rh'] . ' / ' . $r['statut-libelle'] . ")</small>";
                                    } else {
                                        echo $r['intervenant-nom'] . ' ' . $r['intervenant-prenom'] . " <small>(" . $r['statut-libelle'] . ")</small>";
                                    }
                                    ?>
                                </a>
                            </td>

                            <?php
                            foreach ($supCols as $supCol) {
                                printValue($r[$supCol]);
                            } ?>
                        </tr>
                    <?php endforeach; ?>
                    </tbody>
                </table>
                <small><a href="javascript:cocherTout()">Cocher tout</a> / <a href="javascript:decocherTout()">Décocher
                        tout</a></small>
            </div>
        <?php endif; ?>
        <a class="btn btn-secondary" href="<?= $this->url('indicateur'); ?>">
            <i class="fas fa-rotate-left" aria-hidden="true"></i
                    Retour à la liste des indicateurs
        </a>
        <a class="btn btn-secondary"
           href="<?= $this->url('indicateur/export-csv', ['indicateur' => $indicateur->getId()]); ?>">
            <i class="fas fa-upload" aria-hidden="true"></i>
            Export de la liste au format CSV
        </a>
        <?php if ($mailUrl): ?>
            <a id="send-mail-link"
               class="btn btn-primary"
               href="javascript:envoiMail()">Rédiger un mail pour les intervenants sélectionnés...</a>
        <?php endif; ?>
    </div>

<?php if ($mailUrl): ?>
    <script>

        function cocherTout()
        {
            $(".indic-intervenant").prop("checked", true);
        }


        function decocherTout()
        {
            $(".indic-intervenant").prop("checked", false);
        }

        function envoiMail()
        {
            var url = <?= json_encode($mailUrl) ?>;
            var ids = '';
            $(".indic-intervenant:checked").each(function () {

                if (ids != '') ids += '-';
                ids += $(this).val();

            });

            url += '?intervenants=' + ids;

            window.location.href = url;
        }

    </script>
<?php endif; ?>