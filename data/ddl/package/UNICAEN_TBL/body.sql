CREATE OR REPLACE PACKAGE BODY "UNICAEN_TBL" AS

  PROCEDURE DEMANDE_CALCUL( TBL_NAME VARCHAR2, param VARCHAR2, value VARCHAR2 ) IS
  BEGIN
    INSERT INTO tbl_dems (
      ID,
      TBL_NAME,
      PARAM, VALUE
    ) VALUES (
      TBL_DEMS_ID_SEQ.NEXTVAL,
      TBL_NAME,
      PARAM, VALUE
    );
  END;



  FUNCTION MAKE_WHERE(param VARCHAR2 DEFAULT NULL, value VARCHAR2 DEFAULT NULL, alias VARCHAR2 DEFAULT NULL) RETURN VARCHAR2 IS
    res VARCHAR2(120) DEFAULT '';
  BEGIN
    IF param IS NULL THEN
      RETURN '1=1';
    END IF;

    IF alias IS NOT NULL THEN
      res := alias || '.';
    END IF;

    IF value IS NULL THEN
      RETURN res || param || ' IS NULL';
    END IF;

    RETURN res || param || ' = ' || value;
  END;



  PROCEDURE CALCULER( TBL_NAME VARCHAR2 ) IS
  BEGIN
    ANNULER_DEMANDES( TBL_NAME );
    CALCULER(TBL_NAME, null, null);
  END;



  PROCEDURE CALCULER( TBL_NAME VARCHAR2, param VARCHAR2, value VARCHAR2 ) IS
    calcul_proc varchar2(30);
  BEGIN
    IF NOT UNICAEN_TBL.ACTIV_CALCULS THEN RETURN; END IF;

    SELECT custom_calcul_proc INTO calcul_proc FROM tbl WHERE tbl_name = CALCULER.TBL_NAME;

    UNICAEN_TBL.CALCUL_PROC_PARAM := PARAM;
    UNICAEN_TBL.CALCUL_PROC_VALUE := VALUE;
    IF calcul_proc IS NOT NULL THEN
      EXECUTE IMMEDIATE
        'BEGIN ' || calcul_proc || '(UNICAEN_TBL.CALCUL_PROC_PARAM,UNICAEN_TBL.CALCUL_PROC_VALUE); END;'
      ;
    ELSE
      EXECUTE IMMEDIATE
        'BEGIN UNICAEN_TBL.C_' || TBL_NAME || '(UNICAEN_TBL.CALCUL_PROC_PARAM,UNICAEN_TBL.CALCUL_PROC_VALUE); END;'
      ;
    END IF;

  END;



  PROCEDURE ANNULER_DEMANDES IS
  BEGIN
    DELETE FROM tbl_dems;
  END;



  PROCEDURE ANNULER_DEMANDES( TBL_NAME VARCHAR2 ) IS
  BEGIN
    DELETE FROM tbl_dems WHERE tbl_name = ANNULER_DEMANDES.tbl_name;
  END;



  FUNCTION HAS_DEMANDES RETURN BOOLEAN IS
    has_dems NUMERIC;
  BEGIN
    SELECT count(*) INTO has_dems from tbl_dems where rownum = 1;

    RETURN has_dems = 1;
  END;



  PROCEDURE CALCULER_DEMANDES IS
  BEGIN
    FOR d IN (
      SELECT DISTINCT tbl_name, param, value FROM tbl_dems
    ) LOOP
      calculer( d.tbl_name, d.param, d.value );
    END LOOP;

    IF HAS_DEMANDES THEN -- pour les boucles !!
      CALCULER_DEMANDES;
    END IF;
  END;



  -- AUTOMATIC GENERATION --

  -- END OF AUTOMATIC GENERATION --

END UNICAEN_TBL;