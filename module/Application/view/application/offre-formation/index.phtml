<?php
$structuresOptions = \UnicaenApp\Util::collectionAsOptions($structures);
$niveauxOptions    = $niveaux;
$etapesOptions     = \UnicaenApp\Util::collectionAsOptions($etapes);

?>

<style>
    .ui-autocomplete {
        max-height: 300px;
        overflow-y: auto;
        /* prevent horizontal scrollbar */
        overflow-x: hidden;
    }
    /* IE 6 doesn't support max-height
    * we use height instead, but this forces the menu to always be this tall
    */
/*    * html .ui-autocomplete {
        height: 300px;
    }*/
</style>

<div class="jumbotron">
    <h1>Offre de formation <small><?php echo $structuresOptions[$structure] ?></small></h1>
    <!--<p>L'offre de formation est constituée de ses éléments constitutifs les plus précis, correspondant aux cours TD et TP.</p>-->
</div>

<div class="row">
    
    <div class="col-md-9" role="main">

        <!---------------- Champ de recherche d'un élément pédagogique --------------->
        <div class="panel panel-default">
            <div class="panel-heading">Élément</div>
            <div class="panel-body">
                <?php echo $this->form()->openTag($form) ?> 
                <?php echo $this->formControlGroup($form->get('element')); ?>
                <input id="filter" class="btn btn-primary" type="submit" value="Y aller..." name="submit" />
                <?php echo $this->form()->closeTag() ?> 
            </div>
            <script>
                $("body").on("submit", "form.element-rech", function(event) {
                    var form = $(event.target);
                    var id = $("input.sas", form).val();
                    if (id) {
                        $('html, body').animate({
                            scrollTop: $("#" + id).offset().top - $(window).height() / 2
                        }, 500, 'swing', function() { $("#" + id).effect("highlight"); });
                    }
                    event.preventDefault();
                });
            </script>
        </div>
        
        <p><?php echo count($entities) ?> éléments trouvés.</p>
        
        <!---------------- Tableau des éléments pédagogiques --------------->
        <table class="table table-bordered table-condensed table-hover">
            <thead>
                <tr>
                    <th>Niveau</th>
                    <th>Étape</th>
                    <th>Période</th>
                    <th>Code élément</th>
                    <th>Libellé élément</th>
                    <th class="action"></th>
                </tr>
            </thead>
            <tbody>
                <?php foreach ($entities as $entity): /* @var $entity \Application\Entity\Db\ElementPedagogique */ ?>
                <tr id="<?php echo $entity->getId() ?>">
                    <td class=""   ><?php echo $entity->getEtape()->getNiveauToString() ?></td>
                    <td class="etape"><?php echo $entity->getEtape() ?></td>
                    <td class="periode"><?php echo $entity->getPeriode() ?></td>
                    <td class="element"><?php echo $entity->getSourceCode() ?></td>
                    <td class="element"><?php echo $entity->getLibelle() ?></td>
                    <td class="action">
                        <?php $url = $this->url('of/default', 
                                array('action' => 'voir-element'), 
                                array('query' => array('id' => $entity->getId()))) ?>
                        <a class="modal-action" title="Voir le détails de cet élément" 
                           href="<?php echo $url ?>"><span class="glyphicon glyphicon-eye-open"></span></a>
                    </td>
                </tr>
                <?php endforeach; ?>
            </tbody>
        </table>
    </div>
    
    <div class="col-md-3">
        
        <!---------------- Champ de sélection d'une structure --------------->
        <div class="panel panel-default">
            <div class="panel-heading">Structure</div>
            <div class="panel-body">
                <?php
                $selectStructure = new \Zend\Form\Element\Select('structure');
                $selectStructure
                        ->setValueOptions($structuresOptions)
                        ->setValue($structure)
                        ->setAttributes(array('class' => 'struct'));
                echo $this->formSelect($selectStructure);
                ?>
                <script>
                    $("body").on("change", "select.struct", function(event) {
                        $("*").css('cursor', 'wait');
                        var id = $(this).val();
                        var url = '<?php echo $this->url('of', 
                                 array('action' => 'of'), 
                                 array('query' => array(
                                     'structure' => '__structure__', 
                                     /*'niveau' => $niveau, 
                                     'etape' => $etape*/))) ?>';
                        $(location).attr('href', url.replace('__structure__', id));
                    });
                </script>
            </div>
        </div>

        <!---------------- Champ de sélection d'un niveau --------------->
        <div class="panel panel-default">
            <div class="panel-heading">Niveau</div>
            <div class="panel-body">
                <?php
                $niveauxOptions = array_combine(
                        $tmp = array_map(function($v) { return $v['libelleCourt'] . $v['niveau']; }, $niveaux), 
                        $tmp); 
                ?>
                <ul>
                    <li>
                    <?php if (null !== $niveau): ?> 
                         <a class="niveau" href="<?php echo $this->url('of', 
                                 array('action' => 'of'), 
                                 array('query' => array(
                                     'structure' => $structure, 
                                     'niveau' => null,
                                     /*'etape' => $etape*/))) ?>">Tous</a>
                    <?php else: ?>
                        <strong>Tous</strong>
                    <?php endif; ?>
                    </li>
                    <?php foreach ($niveauxOptions as $code => $lib): ?>
                    <li>
                    <?php if ($code != $niveau): ?> 
                         <a class="niveau" href="<?php echo $this->url('of', 
                                 array('action' => 'of'), 
                                 array('query' => array(
                                     'structure' => $structure, 
                                     'niveau' => $code, 
                                     /*'etape' => $etape*/))) ?>"><?php echo $lib ?></a>
                    <?php else: ?>
                        <strong><?php echo $lib ?></strong>
                    <?php endif; ?>
                    </li>
                    <?php endforeach; ?>
                </ul>
                <script>
                    $("body").on("click", "a.niveau", function(event) {
                        $("*").css('cursor', 'wait');
                    });
                </script>
            </div>
        </div>

        <!---------------- Champ de sélection d'une étape --------------->
        <div class="panel panel-default">
            <div class="panel-heading">Étape</div>
            <div class="panel-body">
                <ul>
                    <li>
                    <?php if (null !== $etape): ?> 
                         <a class="etape" href="<?php echo $this->url('of', 
                                 array('action' => 'of'), 
                                 array('query' => array(
                                     'structure' => $structure, 
                                     'niveau' => $niveau, 
                                     'etape' => null))) ?>">Toutes</a>
                    <?php else: ?>
                        <strong>Toutes</strong>
                    <?php endif; ?>
                    </li>
                    <?php foreach ($etapesOptions as $code => $lib): ?>
                    <li>
                    <?php if ($code != $etape): ?> 
                         <a class="etape" href="<?php echo $this->url('of', 
                                 array('action' => 'of'), 
                                 array('query' => array(
                                     'structure' => $structure,
                                     'niveau' => $niveau, 
                                     'etape' => $code))) ?>"><?php echo $lib ?></a>
                    <?php else: ?>
                        <strong><?php echo $lib ?></strong>
                    <?php endif; ?>
                    </li>
                    <?php endforeach; ?>
                </ul>
                <script>
                    $("body").on("click", "a.etape", function(event) {
                        $("*").css('cursor', 'wait');
                    });
                </script>
            </div>
        </div>
        
    </div>
    
</div>

<?php echo $this->modalAjaxDialog('modal-element-details'); ?>
