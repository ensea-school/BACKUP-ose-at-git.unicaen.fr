<?php
use Application\Assertion\PieceJointeAssertion;

$piecesJointes = $this->piecesJointes; /* @var $piecesJointes \Application\Entity\Db\PieceJointe[] */
?>

<?php if (count($piecesJointes)): ?>

<ul>
<?php foreach ($piecesJointes as $pj): ?>
    <li class="fichier-pj">

        <!-- lien de téléchargement de la PJ -->
        <?php 
        $file = sprintf("%s (<abbr title=\"%s octets\">%s</abbr>)", $pj->getNomFichier(), $pj->getTailleFichier(), $pj->getTailleFichierToString());
        ?>
        <?php if ($this->isAllowed($pj, PieceJointeAssertion::PRIVILEGE_TELECHARGER)): ?>
            <?php
            $paramsTelecharger = ['pieceJointe' => $pj->getId(), 'nomFichier' => $pj->getNomFichier()];
            $urlTelecharger    = $this->url('piece-jointe/intervenant/telecharger', $paramsTelecharger, [], true);
            ?>
            <a class="download-file" href="<?php echo $urlTelecharger ?>" title="Télécharger le fichier déposé '<?php echo $pj->getNomFichier() ?>'">
                <span class="glyphicon glyphicon-file"></span> <?php echo $file ?></a> 
        <?php else: ?>
            <span class="glyphicon glyphicon-file"></span> <?php echo $file ?></a> 
        <?php endif; ?>
       
        <!-- lien de suppression de la PJ -->
        <?php if ($this->isAllowed($pj, PieceJointeAssertion::PRIVILEGE_DELETE)): ?>
            <?php
            $paramsSupprimer = ['pieceJointe' => $pj->getId(), 'nomFichier' => $pj->getNomFichier()];
            $urlSupprimer    = $this->url('piece-jointe/intervenant/supprimer', $paramsSupprimer, [], true); 
            ?>
            <a class="delete-file" href="<?php echo $urlSupprimer ?>" title="Supprimer le fichier déposé '<?php echo $pj->getNomFichier() ?>'">
                <span class="glyphicon glyphicon-trash"></span></a> 
        <?php endif; ?>
            
        <!-- affichage de la validation éventuelle de la PJ -->
        <?php if ($pj->getValidation()): ?>
            <?php $title = (string) $pj->getValidation() ?>
            <span class="label label-success" title="<?php echo $title ?>"><span class="glyphicon glyphicon-ok"></span> Validée</span>
        <?php endif ?>
        
        <!-- actions de validation/dévalidation de la PJ -->
        <?php if ($this->isAllowed($pj, PieceJointeAssertion::PRIVILEGE_VALIDER)): ?>
            <?php
            $paramsValider = ['pieceJointe' => $pj->getId()];
            $urlValider    = $this->url('piece-jointe/intervenant/valider', $paramsValider, [], true);
            ?>
            <a class="btn btn-xs btn-default" href="<?php echo $urlValider ?>" title="Valider la pièce '<?php echo $pj->getNomFichier() ?>'">
                <span class="glyphicon glyphicon-thumbs-up"></span> Valider</a> 
        <?php endif ?>
        <?php if ($this->isAllowed($pj, PieceJointeAssertion::PRIVILEGE_DEVALIDER)): ?>
            <?php
            $paramsDevalider = ['pieceJointe' => $pj->getId()];
            $urlDevalider    = $this->url('piece-jointe/intervenant/devalider', $paramsDevalider, [], true); 
            ?>
            <a class="btn btn-xs btn-default" href="<?php echo $urlDevalider ?>" title="Dévalider la pièce '<?php echo $pj->getNomFichier() ?>'">
                <span class="glyphicon glyphicon-thumbs-down"></span> Dévalider</a> 
        <?php endif ?>
            
        <!--<span class="label label-warning"><span class="glyphicon glyphicon-exclamation-sign"></span> Non validée</span>-->
    </li>
<?php endforeach ?>
</ul>

<?php else: ?>

<p>Aucun.</p>

<?php endif ?>